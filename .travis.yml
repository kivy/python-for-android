sudo: required

language: generic

services:
  - docker

before_install:
  - sudo apt update -qq
  - sudo apt install -qq --no-install-recommends python2.7 python3
  - sudo pip install tox>=2.0
  # https://github.com/travis-ci/travis-ci/issues/6069#issuecomment-266546552
  - git remote set-branches --add origin master
  - git fetch

env:
  global:
    - ANDROID_SDK_HOME=/opt/android/android-sdk
    - ANDROID_NDK_HOME=/opt/android/android-ndk
  matrix:
    # test encryption recipes
    - COMMAND='. venv/bin/activate && cd testapps/ && python setup_testapp_python_encryption.py apk --dist-name bdisttest_python3_encryption --sdk-dir $ANDROID_SDK_HOME --ndk-dir $ANDROID_NDK_HOME --requirements python3,libffi,openssl,sdl2,pyjnius,kivy,cryptography,pycrypto,scrypt,m2crypto,pysha3,pycryptodome,libtorrent'
    # overrides requirements to skip `peewee` pure python module, see:
    # https://github.com/kivy/python-for-android/issues/1263#issuecomment-390421054
    - COMMAND='. venv/bin/activate && cd testapps/ && python setup_testapp_python3_sqlite_openssl.py apk --sdk-dir $ANDROID_SDK_HOME --ndk-dir $ANDROID_NDK_HOME --requirements libffi,sdl2,pyjnius,kivy,python3,openssl,requests,sqlite3,setuptools'
    - COMMAND='. venv/bin/activate && cd testapps/ && python setup_testapp_python2_sqlite_openssl.py apk --sdk-dir $ANDROID_SDK_HOME --ndk-dir $ANDROID_NDK_HOME --requirements sdl2,pyjnius,kivy,python2,openssl,requests,sqlite3,setuptools'
    # test webview bootstrap (plus numpy)
    - COMMAND='. venv/bin/activate && cd testapps/ && python setup_testapp_flask.py apk --dist-name bdisttest_python3_flask_webview --sdk-dir $ANDROID_SDK_HOME --ndk-dir $ANDROID_NDK_HOME --requirements python3,flask,pyjnius,numpy'
    # builds only the recipes that moved
    - COMMAND='. venv/bin/activate && ./ci/rebuild_updated_recipes.py'

before_script:
  # we want to fail fast on tox errors without having to `docker build` first
  - tox

script:
  # Capture any error we got while doing our builds
  - trap "echo \"Error...last docker's log build lines:\" & tail -500 build.log & echo \"Error last tests log lines:\" &tail -1000 tests.log" ERR
  # The Docker image build
  - while sleep 1m; do echo "=====[ $SECONDS seconds, docker image still building... ]====="; done & PING_LOOP1_PID=$!
  - docker build --tag=p4a --file Dockerfile.py3 . > build.log 2>&1
  - kill ${PING_LOOP1_PID}
  # The Tests build
  - while sleep 1m; do echo "=====[ $SECONDS seconds, tests still building... ]====="; done & PING_LOOP2_PID=$!
  - docker run p4a /bin/sh -c "$COMMAND" > tests.log 2>&1
  - kill ${PING_LOOP2_PID}
  - echo "All operations performed...last build log lines are:" & tail -500 tests.log
